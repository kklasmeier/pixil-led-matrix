# Sprite Frame Flicker Diagnostic Script v2
# Purpose: Test flicker with CHANGING background content
# 
# The background scrolls left while sprite moves right
# This ensures every frame has different pixel content

v_speed = 0.05
v_frames = 60

# ============================================
# Define a simple, visible sprite
# ============================================
print("Defining sprite...")
sync_queue

define_sprite(test_ball, 8, 8)
    draw_circle(4, 4, 3, white, 100, true)
    plot(4, 4, red, 100)
endsprite

print("Sprite defined.")
sync_queue
rest(0.5)

# ============================================
# TEST A: begin_frame(false) with SCROLLING background
# ============================================
print("=== TEST A: begin_frame(false) with scrolling background ===")
sync_queue

show_sprite(test_ball, 5, 28, 0, 0)
rest(0.3)

v_scroll_offset = 0

for v_frame in (0, v_frames, 1)
    # Calculate positions
    v_sprite_x = 5 + v_frame / 2
    v_scroll_offset = v_scroll_offset + 1
    
    begin_frame(false)
        # Draw scrolling vertical stripes
        for v_x in (0, 63, 1)
            # Calculate stripe color based on scroll offset
            v_stripe = (v_x + v_scroll_offset) % 8
            
            if v_stripe < 4 then
                v_color = "navy"
            else
                v_color = "dark_gray"
            endif
            
            # Draw vertical stripe
            draw_line(v_x, 0, v_x, 63, v_color, 70)
        endfor v_x
        
        # Draw a horizontal reference line that also scrolls
        v_line_y = 32 + sin(v_scroll_offset / 5) * 10
        draw_line(0, v_line_y, 63, v_line_y, yellow, 90)
        
        # Move sprite in opposite direction
        move_sprite(test_ball, v_sprite_x, 28, 0)
    end_frame
    
    rest(v_speed)
endfor v_frame

sync_queue
print("Test A complete.")
sync_queue
rest(1)

# ============================================
# TEST B: begin_frame(true) with same scrolling background
# ============================================
print("=== TEST B: begin_frame(true) with scrolling background ===")
sync_queue

# Reset
move_sprite(test_ball, 5, 28, 0)
v_scroll_offset = 0
rest(0.3)

for v_frame in (0, v_frames, 1)
    v_sprite_x = 5 + v_frame / 2
    v_scroll_offset = v_scroll_offset + 1
    
    begin_frame(true)
        # Clear previous frame content manually since we're preserving
        draw_rectangle(0, 0, 64, 64, black, 100, true)
        
        # Draw scrolling vertical stripes
        for v_x in (0, 63, 1)
            v_stripe = (v_x + v_scroll_offset) % 8
            
            if v_stripe < 4 then
                v_color = "navy"
            else
                v_color = "dark_gray"
            endif
            
            draw_line(v_x, 0, v_x, 63, v_color, 70)
        endfor v_x
        
        # Scrolling reference line
        v_line_y = 32 + sin(v_scroll_offset / 5) * 10
        draw_line(0, v_line_y, 63, v_line_y, yellow, 90)
        
        # Move sprite
        move_sprite(test_ball, v_sprite_x, 28, 0)
    end_frame
    
    rest(v_speed)
endfor v_frame

sync_queue
print("Test B complete.")
sync_queue
rest(1)

# ============================================
# TEST C: No framing at all - direct drawing with sprite
# ============================================
print("=== TEST C: NO FRAMING - direct draw with sprite ===")
sync_queue

# Reset
move_sprite(test_ball, 5, 28, 0)
v_scroll_offset = 0
rest(0.3)

for v_frame in (0, v_frames, 1)
    v_sprite_x = 5 + v_frame / 2
    v_scroll_offset = v_scroll_offset + 1
    
    # No begin_frame - draw directly
    clear()
    
    # Draw scrolling vertical stripes
    for v_x in (0, 63, 1)
        v_stripe = (v_x + v_scroll_offset) % 8
        
        if v_stripe < 4 then
            v_color = "navy"
        else
            v_color = "dark_gray"
        endif
        
        draw_line(v_x, 0, v_x, 63, v_color, 70)
    endfor v_x
    
    # Scrolling reference line
    v_line_y = 32 + sin(v_scroll_offset / 5) * 10
    draw_line(0, v_line_y, 63, v_line_y, yellow, 90)
    
    # Move sprite
    move_sprite(test_ball, v_sprite_x, 28, 0)
    
    rest(v_speed)
endfor v_frame

sync_queue
print("Test C complete.")
sync_queue
rest(1)

# ============================================
# TEST D: Rapid sprite movement with static background
# ============================================
print("=== TEST D: RAPID sprite movement, static background ===")
sync_queue

# Draw static background once
begin_frame(false)
    for v_x in (0, 63, 1)
        v_stripe = v_x % 8
        if v_stripe < 4 then
            v_color = "navy"
        else
            v_color = "dark_gray"
        endif
        draw_line(v_x, 0, v_x, 63, v_color, 70)
    endfor v_x
    draw_line(0, 32, 63, 32, yellow, 90)
end_frame

rest(0.3)

# Now rapid sprite movement with begin_frame(false) but minimal background change
for v_frame in (0, 120, 1)
    v_sprite_x = 5 + v_frame / 2
    if v_sprite_x > 55 then
        v_sprite_x = 55
    endif
    
    v_sprite_y = 28 + sin(v_frame / 8) * 15
    
    begin_frame(false)
        # Redraw static background
        for v_x in (0, 63, 1)
            v_stripe = v_x % 8
            if v_stripe < 4 then
                v_color = "navy"
            else
                v_color = "dark_gray"
            endif
            draw_line(v_x, 0, v_x, 63, v_color, 70)
        endfor v_x
        draw_line(0, 32, 63, 32, yellow, 90)
        
        # Move sprite in a wave pattern
        move_sprite(test_ball, v_sprite_x, v_sprite_y, 0)
    end_frame
    
    # No rest - maximum speed
endfor v_frame

sync_queue
print("Test D complete.")
sync_queue
rest(1)

# ============================================
# Cleanup
# ============================================
print("All tests complete. Cleaning up...")
sync_queue
hide_sprite(test_ball, 0)
dispose_all_sprites()
clear()
print("Done.")
sync_queue
